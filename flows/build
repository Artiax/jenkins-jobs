def name;
def tag;
def image;

node('docker') {
  stage('Checkout') {
    checkout scm
  }

  stage('Prepare') {
    name = sh(returnStdout: true, script: 'basename -s .git `git config --get remote.origin.url`').trim()
    commit = sh(returnStdout: true, script: 'git rev-parse HEAD').trim().take(8)
    timestamp = sh(returnStdout: true, script: "date '+%Y-%m-%d-%H%M'").trim()
    tag = "${timestamp}-${commit}"

    echo "Name: ${name}"
    echo "Tag: ${tag}"
  }

  stage('Build') {
    image = docker.build "${name}"
  }

  stage('Tag') {
    currentBuild.displayName = "${tag}"
    image.tag "${tag}"
  }
}
