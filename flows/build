def scmVars;
def name;
def tag;
def image;

node('docker') {
  stage('Checkout') {
    scmVars = checkout scm;
  }

  stage('Prepare') {
    name = "${env.JOB_BASE_NAME}"
    commit = "${scmVars.GIT_COMMIT}".take(8)
    timestamp = sh(returnStdout: true, script: "date '+%Y-%m-%d-%H%M'").trim()
    tag = "${timestamp}-${commit}"

    echo "Name: ${name}"
    echo "Tag: ${tag}"
  }

  stage('Build') {
    image = docker.build "${name}"
  }

  stage('Tag') {
    currentBuild.displayName = "${tag}"
    image.tag "${tag}"
  }
}
