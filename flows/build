node('docker') {
  def image;

  stage('Build') {
    currentBuild.displayName = "${tag}"
    image = docker.build '${name}'
  }

  stage('Tag') {
    image.tag "${tag}"
    image.tag "latest"
  }
}

timeout(time: 15, unit: 'MINUTES') {
  try {
    input(id: 'deploy', message: 'Deploy this image?')
    build job: 'deployments/${metadata.name}', parameters: [string(name: 'RELEASE_NAME', value: 'jenkins'),string(name: 'TAG', value: "${tag}")], wait: false
  } catch(err) {
    currentBuild.result = 'SUCCESS'
  }
}
